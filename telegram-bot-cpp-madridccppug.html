<!DOCTYPE html>
<html lang="es">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="https://jgsogo.es/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://jgsogo.es/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="https://jgsogo.es/theme/css/font-awesome.min.css">
  <link href="https://jgsogo.es/static/custom.css" rel="stylesheet">
  <link href="https://jgsogo.es/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Javier G. Sogo's blog Atom">
  <link rel="shortcut icon" href="http://localhost:8000/images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="http://localhost:8000/images/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="Javier G. Sogo" />
<meta name="description" content="Un punto de encuentro habitual entre la programación y la lingüística son los chatbots, se trata de aplicaciones que permiten interactuar con los usuarios a través de plataformas como WhatsApp o Telegram. Para alguien como yo, con interés en ambos campos, éste es un lugar habitaual al que vuelvo una …" />
<meta name="keywords" content="chatbot, c++, telegram, conan">
<meta property="og:site_name" content="Javier G. Sogo's blog"/>
<meta property="og:title" content="Un bot de Telegram con C++"/>
<meta property="og:description" content="Un punto de encuentro habitual entre la programación y la lingüística son los chatbots, se trata de aplicaciones que permiten interactuar con los usuarios a través de plataformas como WhatsApp o Telegram. Para alguien como yo, con interés en ambos campos, éste es un lugar habitaual al que vuelvo una …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://jgsogo.es/telegram-bot-cpp-madridccppug.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-03-24 13:30:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://jgsogo.es/author/javier-g-sogo.html">
<meta property="article:section" content="C++"/>
<meta property="article:tag" content="chatbot"/>
<meta property="article:tag" content="c++"/>
<meta property="article:tag" content="telegram"/>
<meta property="article:tag" content="conan"/>
<meta property="og:image" content="http://localhost:8000/images/profile.png">  <title>Javier G. Sogo's blog &ndash; Un bot de Telegram con C++</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://jgsogo.es">
        <img src="http://localhost:8000/images/profile.png" alt="Javier G. Sogo" title="Javier G. Sogo">
      </a>
      <h1><a href="https://jgsogo.es">Javier G. Sogo</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="https://jgsogo.es/pages/contact.html#contact">Contacto</a></li>
          <li><a href="https://jgsogo.es/pages/about-me.html#about-me">Yo, mí, me, conmigo</a></li>
          <li><a href="http://lingwars.github.io/blog/" target="_blank">Lingẅars</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://es.linkedin.com/in/jgsogo" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/jgsogo" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/jgsogo" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="http://localhost:8000feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="https://jgsogo.es">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="https://jgsogo.es/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="telegram-bot-cpp-madridccppug">Un bot de Telegram con C++</h1>
    <p>Posted on Sun 24 March 2019 in <a href="https://jgsogo.es/category/c.html">C++</a></p>
  </header>
  <div>
    
<p>Un punto de encuentro habitual entre la programación y la lingüística son los chatbots,
se trata de aplicaciones que permiten interactuar con los usuarios a través de plataformas
como WhatsApp o Telegram. Para alguien como yo, con interés en ambos campos, éste es un
lugar habitaual al que vuelvo una y otra vez, y así ha sido, esta vez desde el mundo
del C++.</p>
<p>Hasta ahora siempre había hecho los chatbots utilizando Python, así funcionan el que
planteamos para Neutrón o el que utilizo para enterarme de ofertas en Wallapop, los ejecuto en
mi Raspberry y siempre tengo acceso a ellos a través de mi teléfono. Una interfaz sencilla,
siempre disponible y que no requiere de ninguna configuración de red.</p>
<p>En el mundo del C++ todo parece más complicado, todo lo que se encuentra en torno al
lenguaje parece estar relacionado con librerías, con técnicas para modernizar el código,
pero muy pocas veces podemos leer sobre ejemplos de aplicaciones o pequeños prototipos
creados con él. Pero yo creo que el ecosistema está madurando, que el lenguaje ha
adquirido ciertas características que aumentan su expresividad y el ecosistema se ha
dotado de herramientas que hacen más accesible el sentarse delante del ordenador y
programar la parte que nos interesa sin preocuparnos por todo lo demás.</p>
<p>¡Vamos allá!</p>
<div class="section" id="arquitectura-de-un-chatbot">
<h2><a class="toc-backref" href="#id1">Arquitectura de un chatbot</a></h2>
<p>Un bot de Telegram (extensible a prácticamente cualquier otro bot) es una aplicación
conectada continuamente al sistema de mensajería de Telegram y que responde a
notificaciones procedentes del servidor mensajes.</p>
<div class="figure align-center">
<img alt="Arquitectura de un bot de Telegram" src="https://jgsogo.es/images/2019.03.telegram-bot/architecture.png"/>
<p class="caption">Diagrama explicativo con la arquitectura de un bot de telegram</p>
</div>
<p>Los usuarios individualmente podrán iniciar una conversación con el bot como si fuera
un usuario más y conversarán con él en su chat privado; por lo tanto, y esto lo
tendremos que tener en cuenta a la hora de programar, el bot debe ser capaz de mantener
un número arbitrario de conversaciones simultaneas, sabremos a cuál se refiere cada
mensaje porque irá acompañado de un identificador único.</p>
<p>Apoyándonos en librerías existentes, nuestra tarea se reduce únicamente a programar cuáles
son las respuestas del bot a cada uno de los mensajes que los usuarios pueden enviarnos.</p>
</div>
<div class="section" id="la-libreria-tgbot-cpp">
<h2><a class="toc-backref" href="#id2">La librería tgbot-cpp</a></h2>
<p>Para construir nuestro ejemplo utilizaremos la librería <a class="reference external" href="https://github.com/reo7sp/tgbot-cpp">tgbot-cpp</a> de <a class="reference external" href="https://github.com/reo7sp">Oleg Morozenkov</a>
que podemos encontrar en Github. No necesitamos entrar en la librería para utilizarla, es
más nos bastará con tener unos conocimientos muy básicos, incluso de C++, para poder
echar a andar nuestro bot.</p>
<p>La librería tiene algunas dependencias que necesitaremos tener en nuestro sistema
para poder compilarla, puedes utilizar diferentes estrategias para instalarlas en tu
ordenador, personalmente te recomiendo que utilices <a class="reference external" href="https://conan.io">Conan</a>, pero siéntete libre de
luchar contra los elementos utilizando las armas que consideres oportunas.</p>
<p>Si optas por Conan, simplemente tendrás que seguir los siguientes pasos:</p>
<pre class="code bash literal-block">
pip install conan
conan profile show default
</pre>
<p>Si utilizas GCC, échale un ojo a este trozo de la documentación donde se habla de la
compatibilidad binaria: <a class="reference external" href="https://docs.conan.io/en/latest/howtos/manage_gcc_abi.html">How to manage the GCC&gt;=5 ABI</a>, probablemente quieras
modificar la <em>libcxx</em> que Conan ha elegido por defecto.</p>
<p>Una vez instalado Conan, añade los repositorios remotos necesarios de donde se
descargarán las recetas:</p>
<pre class="code bash literal-block">
conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan
conan remote add jgsogo https://api.bintray.com/conan/jgsogo/conan-packages
</pre>
<p>E instala la librería, así la tendremos disponible para próximos pasos:</p>
<pre class="code bash literal-block">
conan install tgbot_cpp/1.1@jgsogo/stable --build<span class="o">=</span>missing
</pre>
</div>
<div class="section" id="ejemplo-de-bot-lo-minimo-necesario">
<h2><a class="toc-backref" href="#id3">Ejemplo de bot, lo mínimo necesario</a></h2>
<p>El mínimo ejemplo que podemos construir con un bot es uno que nos conteste siempre
lo mismo, peor nos servirá de ejemplo para probar que todo funciona. Este ejemplo
es el que ya nos ofrece la documentación de su librería: un bot que responde con
un simple <code>"Hi!"</code> cuando nos conectamos a él y que después nos devuelve el mismo
mensaje que le hemos enviado:</p>
<pre class="code cpp literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tgbot/tgbot.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Initialize the bot
</span>    <span class="n">TgBot</span><span class="o">::</span><span class="n">Bot</span> <span class="n">bot</span><span class="p">(</span><span class="s">"PLACE YOUR TOKEN HERE"</span><span class="p">);</span>

    <span class="c1">// Connect to events and define actions using callbacks
</span>    <span class="n">bot</span><span class="p">.</span><span class="n">getEvents</span><span class="p">().</span><span class="n">onCommand</span><span class="p">(</span><span class="s">"start"</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">bot</span><span class="p">](</span><span class="n">TgBot</span><span class="o">::</span><span class="n">Message</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bot</span><span class="p">.</span><span class="n">getApi</span><span class="p">().</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">chat</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">"Hi!"</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="n">bot</span><span class="p">.</span><span class="n">getEvents</span><span class="p">().</span><span class="n">onAnyMessage</span><span class="p">([</span><span class="o">&amp;</span><span class="n">bot</span><span class="p">](</span><span class="n">TgBot</span><span class="o">::</span><span class="n">Message</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"User wrote %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">StringTools</span><span class="o">::</span><span class="n">startsWith</span><span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">,</span> <span class="s">"/start"</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">bot</span><span class="p">.</span><span class="n">getApi</span><span class="p">().</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">chat</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">"Your message is: "</span> <span class="o">+</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="c1">// Run the infinite loop
</span>    <span class="k">try</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Bot username: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">bot</span><span class="p">.</span><span class="n">getApi</span><span class="p">().</span><span class="n">getMe</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">TgBot</span><span class="o">::</span><span class="n">TgLongPoll</span> <span class="n">longPoll</span><span class="p">(</span><span class="n">bot</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Long poll started</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">longPoll</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">TgBot</span><span class="o">::</span><span class="n">TgException</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>En el código anterior hay tres partes diferenciadas:</p>
<ul>
<li><p class="first">La construcción del bot, un objeto de la clase <code>TgBot::Bot</code> al que hay que pasarle
un <em>token</em> (más adelante hablaremos de esto).</p>
</li>
<li><p class="first">Conectar nuestras acciones a los eventos generados por el bot, hay dos tipos de estos
eventos:</p>
<ul class="simple">
<li>los comandos, son aquellos que el usuario introduce precedidos por <code>/</code>
(ejemplos típicos serían <code>/start</code> o <code>/help</code>), y</li>
<li>los mensajes de texto, todos ellos entrarán a través del evento <code>onAnyMessage</code>.</li>
</ul>
<p>Como se puede ver en el ejemplo, se están conectando unos <em>callbacks</em> a cada uno de los
eventos anteriores, su implementación se corresponde con la que presentamos al introducir
el ejemplo del bot.</p>
</li>
<li><p class="first">Ejecutar el bot utilizando un bucle infinito.</p>
</li>
</ul>
</div>
<div class="section" id="como-compilarlo">
<h2><a class="toc-backref" href="#id4">Cómo compilarlo</a></h2>
<p>Si provienes de Python o de otros lenguajes interpretados quizá esto te sorprenda, pero el
código de C++ hay que compilarlo, no basta con ejecutarlo como si fuera un <em>script</em>, no;
necesitamos generar el binario de la aplicación, el <code>.exe</code>, que será lo que ejecutemos.
En esto se basan los mayores logros y desencantos de este lenguaje.</p>
<p>Para compilarlo utilizaré <a class="reference external" href="https://cmake.org/">CMake</a> y por lo tanto hará falta un fichero <code>CMakeLists.txt</code>
para nuestro proyecto:</p>
<pre class="code cmake literal-block">
<span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">2.8.12</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">BotHelloWorld</span> <span class="s">CXX</span><span class="p">)</span>

<span class="nb">include</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="o">}</span><span class="s">/conanbuildinfo.cmake</span><span class="p">)</span>
<span class="nb">conan_basic_setup</span><span class="p">()</span>

<span class="nb">add_executable</span><span class="p">(</span><span class="s">bot_hello_world</span> <span class="s">main.cpp</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">bot_hello_world</span> <span class="o">${</span><span class="nv">CONAN_LIBS</span><span class="o">}</span><span class="p">)</span>
<span class="nb">set_target_properties</span><span class="p">(</span><span class="s">bot_hello_world</span> <span class="s">PROPERTIES</span> <span class="s">CXX_STANDARD</span> <span class="s">11</span><span class="p">)</span>
</pre>
<p>Mejor que copiar los <em>snippets</em> de código que aparecen aquí es que te clones el repositorio que
hemos preparado en el <a class="reference external" href="https://madridccppug.github.io/meetups/">grupo de usuarios de C++ de Madrid</a> con algunos ejemplos y que lo
compiles desde allí:</p>
<pre class="code bash literal-block">
git clone https://github.com/madridccppug/workshop-telegram-bot.git
<span class="nb">cd</span> workshop-telegram-bot/hello_world

mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd</span> build
conan install .. --build<span class="o">=</span>missing
cmake .. -DCMAKE_BUILD_TYPE<span class="o">=</span>Release
cmake --build .

./bin/bot_hello_world
</pre>
<div class="section" id="el-token-tu-bot">
<h3><a class="toc-backref" href="#id5">El token, tu bot</a></h3>
<p>Si has llegado hasta aquí, habrás visto que el bot necesita un token para funcionar, y si has
echado un vistazo al código fuente también sabrás que en nuestros utilizamos la variable de
entorno <code>MADRIDCCPPUG_BOT_TOKEN</code> para pasarle este token a nuestro bot.</p>
<p>Cada <strong>token identifica a un bot diferente</strong>, es la clave que permite que tu programa se
identifique contra los servidores de Telegram y que el intercambio de mensajes entre los usuarios
y tu bot llegue a tu aplicación en vez de hacerlo a cualquier otra. Conseguir un <em>token</em> es
muy sencillo, sólo tendrás que iniciar una conversación (utilizando Telegram) con el
<a class="reference external" href="https://telegram.me/BotFather">BotFather</a>, el bot de Telegram que te permite dar de alta nuevos bots.</p>
<div class="figure align-center">
<img alt="Logotipo BotFather" src="https://jgsogo.es/images/2019.03.telegram-bot/botfather.png"/>
<p class="caption">The BotFather</p>
</div>
</div>
</div>
<div class="section" id="otros-bots-de-ejemplo">
<h2><a class="toc-backref" href="#id6">Otros bots de ejemplo</a></h2>
<p>En el repositorio que te has clonado anteriormente tienes disponibles otros ejemplos de bots,
todos ellos se compilan y funcionan de la misma forma:</p>
<ul class="simple">
<li><code>random_chat</code>: se trata de un bot que conecta dos a dos a los usuarios que están
hablando con él en ese momento, tal y como hacía el <a class="reference external" href="https://es.wikipedia.org/wiki/Chatroulette">Chatroulette</a> pero en formato
conversacional.</li>
<li><code>wordnet_game</code>: este bot es un trivial de definiciones en inglés. El bot muestra una
definición y ofrece cuatro palabras, sólo una de ellas se corresponde con la definición.
Para programar este juego he utilizado también la librería <a class="reference external" href="https://github.com/jardon-u/wordnet-blast">wordnet-blast</a> que permite
el acceso desde C++ a la base de datos de <a class="reference external" href="https://wordnet.princeton.edu/">WordNet</a> de la cual, sin lugar a dudas, merece
la pena hablar en otra ocasión.</li>
</ul>
<p>___</p>
</div>
<div class="section" id="notas-y-materiales">
<h2><a class="toc-backref" href="#id7">Notas y materiales</a></h2>
<ul class="simple">
<li>Repositorio con ejemplos: <a class="reference external" href="https://github.com/madridccppug/workshop-telegram-bot">https://github.com/madridccppug/workshop-telegram-bot</a></li>
<li>Diapositivas correspondientes a la presentación del 21 de marzo de 2019 en grupo
de usuarios de C++ de Madrid: <a class="reference external" href="https://docs.google.com/presentation/d/1B5pPftL06dW1k87M5eyMk-MwfkqXWhzXmXrN0kKP0dk/edit?usp=sharing">https://docs.google.com/presentation/d/1B5pPftL06dW1k87M5eyMk-MwfkqXWhzXmXrN0kKP0dk/edit?usp=sharing</a></li>
</ul>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://jgsogo.es/tag/chatbot.html">chatbot</a>
      <a href="https://jgsogo.es/tag/c.html">c++</a>
      <a href="https://jgsogo.es/tag/telegram.html">telegram</a>
      <a href="https://jgsogo.es/tag/conan.html">conan</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jgsogoes';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
<p>
  &copy; Javier G. Sogo 2021 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Un bot de Telegram con C++",
  "headline": "Un bot de Telegram con C++",
  "datePublished": "2019-03-24 13:30:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Javier G. Sogo",
    "url": "https://jgsogo.es/author/javier-g-sogo.html"
  },
  "image": "http://localhost:8000/images/profile.png",
  "url": "https://jgsogo.es/telegram-bot-cpp-madridccppug.html",
  "description": "Un punto de encuentro habitual entre la programación y la lingüística son los chatbots, se trata de aplicaciones que permiten interactuar con los usuarios a través de plataformas como WhatsApp o Telegram. Para alguien como yo, con interés en ambos campos, éste es un lugar habitaual al que vuelvo una …"
}
</script></body>
</html>