<!DOCTYPE html>
<html lang="es">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="https://jgsogo.es/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://jgsogo.es/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="https://jgsogo.es/theme/css/font-awesome.min.css">
  <link href="https://jgsogo.es/static/custom.css" rel="stylesheet">
  <link href="https://jgsogo.es/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Javier G. Sogo's blog Atom">
  <link rel="shortcut icon" href="http://localhost:8000/images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="http://localhost:8000/images/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="Javier G. Sogo" />
<meta name="description" content="Este post es un apunte rápido para documentar una implementación de funciones lazy a través de decoradores en una clase de Ptyhon. La idea es tener una forma sencilla de definir funciones de una clase que: se puedan ejecutar tan pronto como se crea un objeto (o no), almacenen en …" />
<meta name="keywords" content="python, lazy, snippet">
<meta property="og:site_name" content="Javier G. Sogo's blog"/>
<meta property="og:title" content="Métodos lazy (opcionales) en una clase"/>
<meta property="og:description" content="Este post es un apunte rápido para documentar una implementación de funciones lazy a través de decoradores en una clase de Ptyhon. La idea es tener una forma sencilla de definir funciones de una clase que: se puedan ejecutar tan pronto como se crea un objeto (o no), almacenen en …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://jgsogo.es/python-lazy-methods.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-04-13 10:20:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://jgsogo.es/author/javier-g-sogo.html">
<meta property="article:section" content="Python"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="lazy"/>
<meta property="article:tag" content="snippet"/>
<meta property="og:image" content="http://localhost:8000/images/profile.png">  <title>Javier G. Sogo's blog &ndash; Métodos lazy (opcionales) en una clase</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://jgsogo.es">
        <img src="http://localhost:8000/images/profile.png" alt="Javier G. Sogo" title="Javier G. Sogo">
      </a>
      <h1><a href="https://jgsogo.es">Javier G. Sogo</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="https://jgsogo.es/pages/contact.html#contact">Contacto</a></li>
          <li><a href="https://jgsogo.es/pages/about-me.html#about-me">Yo, mí, me, conmigo</a></li>
          <li><a href="http://lingwars.github.io/blog/" target="_blank">Lingẅars</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://es.linkedin.com/in/jgsogo" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/jgsogo" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/jgsogo" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="http://localhost:8000feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="https://jgsogo.es">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="https://jgsogo.es/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="python-lazy-methods">Métodos lazy (opcionales) en una clase</h1>
    <p>Posted on Fri 13 April 2018 in <a href="https://jgsogo.es/category/python.html">Python</a></p>
  </header>
  <div>
    <p>Este post es un <strong>apunte rápido</strong> para documentar una implementación de funciones <tt class="docutils literal">lazy</tt> a través de
decoradores en una clase de Ptyhon. La idea es tener una forma sencilla de definir funciones de
una clase que:</p>
<ul class="simple">
<li>se puedan ejecutar tan pronto como se crea un objeto (o no),</li>
<li>almacenen en caché el resultado de la función</li>
</ul>
<p>esta implementación puede ser útil en el contexto de clases cuyo objetivo es parsear archivos
de texto pesados. La ejecución inmediata permita conocer tan pronto como sea posible si hay
algún error en el formato.</p>
<p>Las piezas necesarias para montarlo son:</p>
<ul>
<li><p class="first">Un decorador:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">lazy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy_keyword</span> <span class="o">=</span> <span class="s1">'__</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Do not use &#64;lazy for free functions like '</span><span class="si">{}</span><span class="s2">'. Did you intend &#64;memoize?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">wrapped_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_keyword</span><span class="p">):</span>
                    <span class="c1"># setattr(inst, self.lazy_keyword, self.func(inst, *args, **kwargs))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_keyword</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_keyword</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wrapped_func</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">init_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">LazyMixin</span><span class="p">),</span> <span class="s2">&quot;Use &#64;lazy for member functions of classes that inherit from LazyMixin&quot;</span>

        <span class="k">def</span> <span class="nf">wrapped_func</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_keyword</span><span class="p">):</span>
                <span class="c1"># setattr(inst, self.lazy_keyword, self.func(inst, *args, **kwargs))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_keyword</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_keyword</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_lazy_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapped_func</span><span class="p">)</span>
</pre>
</li>
<li><p class="first">Una metaclase:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">MetaLazy</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">classdict</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">'LazyMixin'</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_lazy_functions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># getmembers retrieves all attributes</span>
        <span class="c1"># including those inherited from parents</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">lazy</span><span class="p">):</span>
                <span class="n">v</span><span class="o">.</span><span class="n">init_cls</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</pre>
</li>
<li><p class="first">Una clase base:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">LazyMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">MetaLazy</span>

    <span class="n">_lazy_functions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">invoke_lazy_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_functions</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre>
</li>
</ul>
<p>Apoyándose en esto, uno puede definir clases que tengan funciones <cite>lazy</cite>:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">ALazyClass</span><span class="p">(</span><span class="n">LazyMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lazy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invoke_lazy_functions</span><span class="p">()</span>

    <span class="nd">&#64;lazy</span>
    <span class="k">def</span> <span class="nf">lazy1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;return 23&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">23</span>
</pre>
<p>...espero volver pronto por aquí para mejorar este apunte.</p>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://jgsogo.es/tag/python.html">python</a>
      <a href="https://jgsogo.es/tag/lazy.html">lazy</a>
      <a href="https://jgsogo.es/tag/snippet.html">snippet</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jgsogoes';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
<p>
  &copy; Javier G. Sogo 2021 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Métodos lazy (opcionales) en una clase",
  "headline": "Métodos lazy (opcionales) en una clase",
  "datePublished": "2018-04-13 10:20:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Javier G. Sogo",
    "url": "https://jgsogo.es/author/javier-g-sogo.html"
  },
  "image": "http://localhost:8000/images/profile.png",
  "url": "https://jgsogo.es/python-lazy-methods.html",
  "description": "Este post es un apunte rápido para documentar una implementación de funciones lazy a través de decoradores en una clase de Ptyhon. La idea es tener una forma sencilla de definir funciones de una clase que: se puedan ejecutar tan pronto como se crea un objeto (o no), almacenen en …"
}
</script></body>
</html>