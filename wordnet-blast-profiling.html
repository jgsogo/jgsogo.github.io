<!DOCTYPE html>
<html lang="es">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="https://jgsogo.es/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://jgsogo.es/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="https://jgsogo.es/theme/css/font-awesome.min.css">
  <link href="https://jgsogo.es/static/custom.css" rel="stylesheet">
  <link href="https://jgsogo.es/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Javier G. Sogo's blog Atom">
  <link rel="shortcut icon" href="http://localhost:8000/images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="http://localhost:8000/images/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="Javier G. Sogo" />
<meta name="description" content="WordNet-blast es una biblioteca de C++ creada por Ugo Jardonnet para construir en memoria el gráfico de WordNet y permitir un acceso rápido a los synsets y sus relaciones. Encontré esta librería buscando recursos lingüísticos para mi tesis de fin de máster, en ella necesitaba cálcular la distancia semántica entre …" />
<meta name="keywords" content="profiling, boost-graph-library, _ITERATOR_DEBUG_LEVEL, workaround">
<meta property="og:site_name" content="Javier G. Sogo's blog"/>
<meta property="og:title" content="WordNet-blast. Con boost::add_edge hemos topado."/>
<meta property="og:description" content="WordNet-blast es una biblioteca de C++ creada por Ugo Jardonnet para construir en memoria el gráfico de WordNet y permitir un acceso rápido a los synsets y sus relaciones. Encontré esta librería buscando recursos lingüísticos para mi tesis de fin de máster, en ella necesitaba cálcular la distancia semántica entre …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://jgsogo.es/wordnet-blast-profiling.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-08-20 12:54:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://jgsogo.es/author/javier-g-sogo.html">
<meta property="article:section" content="C++"/>
<meta property="article:tag" content="profiling"/>
<meta property="article:tag" content="boost-graph-library"/>
<meta property="article:tag" content="_ITERATOR_DEBUG_LEVEL"/>
<meta property="article:tag" content="workaround"/>
<meta property="og:image" content="http://localhost:8000/images/profile.png">  <title>Javier G. Sogo's blog &ndash; WordNet-blast. Con boost::add_edge hemos topado.</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://jgsogo.es">
        <img src="http://localhost:8000/images/profile.png" alt="Javier G. Sogo" title="Javier G. Sogo">
      </a>
      <h1><a href="https://jgsogo.es">Javier G. Sogo</a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="https://jgsogo.es/pages/contact.html#contact">Contacto</a></li>
          <li><a href="https://jgsogo.es/pages/about-me.html#about-me">Yo, mí, me, conmigo</a></li>
          <li><a href="http://lingwars.github.io/blog/" target="_blank">Lingẅars</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://es.linkedin.com/in/jgsogo" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/jgsogo" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/jgsogo" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="http://localhost:8000feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="https://jgsogo.es">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="https://jgsogo.es/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h1 id="wordnet-blast-profiling">WordNet-blast. Con boost::add_edge hemos topado.</h1>
    <p>Posted on Thu 20 August 2015 in <a href="https://jgsogo.es/category/c.html">C++</a></p>
  </header>
  <div>
    <p><a href="https://github.com/jardon-u/wordnet-blast">WordNet-blast</a> es una biblioteca de C++ creada por
<a href="http://logserv.free.fr/">Ugo Jardonnet</a> para construir en memoria el gráfico de
<a href="http://wordnet.princeton.edu/">WordNet</a> y permitir un acceso rápido a los <em>synsets</em> y sus
relaciones.</p>
<p>Encontré esta librería buscando recursos lingüísticos para mi tesis de fin de máster, en ella
necesitaba cálcular la distancia semántica entre conceptos y para ello utilizaba el grafo de WordNet,
así que esta librería, que utiliza la Boost Graph Library (BGL), resultaba perfecta para lo que
quería hacer.</p>
<p><em>NOTA.- En todo lo que se sigue hay que tener en cuenta que las pruebas se han realizado con Microsoft Visual Studio Premium 2013. Version 12.0.40418.00 Update 5 RC.</em></p>
<p>Sin embargo, había un <strong>problema</strong>: el tiempo empleado en la construcción del grafo en memoria era
excesivo cuando se ejecutaba en <em>debug</em> (hablo de minutos) lo que complicaba las tareas de depuración.
Así que aprovechando unos días de relax me he dedicado a darle un lavado de cara a la librería y a
tratar de acelerar la construcción del grafo en <a href="https://github.com/jgsogo/wordnet-blast">mi repositorio</a>.</p>
<p>Sin embargo, no he sido capaz (aún). Me he encontrado con un caballo de batalla contra el que no quiero
pelear: la función <code>_Orphan_me</code>, que, tal y como se ve en la imagen siguiente, supone más del 90% del tiempo
de ejecución de la aplicación:</p>
<p><img alt="Profiling WordNet-blast" src="/images/wordnet-blast_profiling_1.png"></p>
<p>Esta función es llamada desde <code>boost::add_edge</code> cuando se crea un nuevo arco en el grafo. es decir, cada
vez que añadimos una nueva relación al grafo de WordNet que estamos construyendo en memoria:</p>
<p><img alt="boost::add_edge" src="/images/wordnet-blast_profiling_2.png"></p>
<p>Si buscamos el código de la función podemos ver que sólo se ejecuta en caso de que la macro de preprocesador
<code>_ITERATOR_DEBUG_LEVEL</code> valga 2. Es decir, que sólo tenemos que preocuparnos si estamos compilando con
Microsoft y en debug (salvo que establezcamos este valor nosotros mismos) (<strong>NOTA</strong> Esta macro se añade en
Microsoft Visual Studio 2010).</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">_Orphan_me</span><span class="p">()</span>
        <span class="p">{</span>   <span class="c1">// cut ties with parent</span>
 <span class="cp">#if _ITERATOR_DEBUG_LEVEL == 2</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_Myproxy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>   <span class="c1">// adopted, remove self from list</span>
            <span class="n">_Iterator_base12</span> <span class="o">**</span><span class="n">_Pnext</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_Myproxy</span><span class="o">-&gt;</span><span class="n">_Myfirstiter</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">_Pnext</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">_Pnext</span> <span class="o">!=</span> <span class="k">this</span><span class="p">)</span>
                <span class="n">_Pnext</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">_Pnext</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">_Mynextiter</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">_Pnext</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">_DEBUG_ERROR</span><span class="p">(</span><span class="s">&quot;ITERATOR LIST CORRUPTED!&quot;</span><span class="p">);</span>
            <span class="o">*</span><span class="n">_Pnext</span> <span class="o">=</span> <span class="n">_Mynextiter</span><span class="p">;</span>
            <span class="n">_Myproxy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
 <span class="cp">#endif </span><span class="cm">/* _ITERATOR_DEBUG_LEVEL == 2 */</span><span class="cp"></span>
        <span class="p">}</span>
</code></pre></div>


<p>Para más información sobre <code>_ITERATOR_DEBUG_LEVEL</code> puedes consultar esta
<a href="https://msdn.microsoft.com/en-us/library/hh697468.aspx">documentación de Microsoft</a>, o este
<a href="https://channel9.msdn.com/Series/C9-Lectures-Stephan-T-Lavavej-Advanced-STL/C9-Lectures-Stephan-T-Lavavej-Advanced-STL-3-of-n">vídeo de Stephan T. Lavavej</a>:</p>
<iframe src="https://channel9.msdn.com/Series/C9-Lectures-Stephan-T-Lavavej-Advanced-STL/C9-Lectures-Stephan-T-Lavavej-Advanced-STL-3-of-n/player" width="640" height="360" allowFullScreen frameBorder="0"></iframe>

<h3>Workaround</h3>
<p>Entonces, ¿qué podemos hacer? Básicamente eliminar todas las comprobaciones que se realizan por defecto
en debug (<code>_ITERATOR_DEBUG_LEVEL == 2</code>) y cambiar el valor de esta macro. Debemos tener en cuenta que
al eliminar todas estas comprobaciones, en caso de error en el código, tendremos un comportamiento indeterminado
en vez de la <em>amigable</em> alerta <em>Debug Assertion</em> que nos indica que algo ha ido mal y nos permite ir al punto
del código donde ha sucedido.</p>
<p>Como siempre, hay solución/workaround, pero hay que tener muy presente cuáles son las consecuencias (<em>side effects</em>).</p>
<p>Seguimos trabajando en ello.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://jgsogo.es/tag/profiling.html">profiling</a>
      <a href="https://jgsogo.es/tag/boost-graph-library.html">boost-graph-library</a>
      <a href="https://jgsogo.es/tag/_iterator_debug_level.html">_ITERATOR_DEBUG_LEVEL</a>
      <a href="https://jgsogo.es/tag/workaround.html">workaround</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jgsogoes';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
<p>
  &copy; Javier G. Sogo 2021 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "WordNet-blast. Con boost::add_edge hemos topado.",
  "headline": "WordNet-blast. Con boost::add_edge hemos topado.",
  "datePublished": "2015-08-20 12:54:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Javier G. Sogo",
    "url": "https://jgsogo.es/author/javier-g-sogo.html"
  },
  "image": "http://localhost:8000/images/profile.png",
  "url": "https://jgsogo.es/wordnet-blast-profiling.html",
  "description": "WordNet-blast es una biblioteca de C++ creada por Ugo Jardonnet para construir en memoria el gráfico de WordNet y permitir un acceso rápido a los synsets y sus relaciones. Encontré esta librería buscando recursos lingüísticos para mi tesis de fin de máster, en ella necesitaba cálcular la distancia semántica entre …"
}
</script></body>
</html>